<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netellus - ä¼æ¥­æ¸›ç¢³æ±ºç­–æ”¯æ´ç³»çµ±</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- External CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Prop-Types is required by Recharts UMD build and fixes the 'oneOfType' error -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#064E3B',
                        accent: '#34FF5B',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at 0% 0%, #10B981 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, #34FF5B 0%, transparent 50%),
                #F8FAFC;
            opacity: 0.15;
        }

        .netellus-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid white;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(203, 213, 225, 0.5);
        }

        input:focus {
            outline: none;
            border-color: #34FF5B;
            background: white;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 9999px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-in {
            animation: slideInUp 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const {
            PieChart, Pie, Cell, ResponsiveContainer, Tooltip
        } = Recharts;

        // --- Configuration ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzFq48s8By-nV9hbY9CetGeza3OjzJ5uHLLKrvhS6AYhplYk47rBrfVEsBDlYpWDz32/exec";

        const INDUSTRIES = [
            "é›»å­é›¶çµ„ä»¶è£½é€ æ¥­", "é›»è…¦ã€é›»å­ç”¢å“åŠå…‰å­¸è£½å“è£½é€ æ¥­", "é›»åŠ›è¨­å‚™åŠé…å‚™è£½é€ æ¥­",
            "æ©Ÿæ¢°è¨­å‚™è£½é€ æ¥­", "é‡‘å±¬è£½å“è£½é€ æ¥­", "åŸºæœ¬é‡‘å±¬è£½é€ æ¥­", "åŒ–å­¸ææ–™åŠè‚¥æ–™è£½é€ æ¥­",
            "å…¶ä»–åŒ–å­¸è£½å“è£½é€ æ¥­", "è—¥å“åŠé†«ç”¨åŒ–å­¸è£½å“è£½é€ æ¥­", "å¡‘è† è£½å“è£½é€ æ¥­",
            "æ©¡è† è£½å“è£½é€ æ¥­", "éé‡‘å±¬ç¤¦ç‰©è£½å“è£½é€ æ¥­", "çŸ³æ²¹åŠç…¤è£½å“è£½é€ æ¥­",
            "ç´¡ç¹”æ¥­", "æˆè¡£åŠæœé£¾å“è£½é€ æ¥­", "çš®é©ã€æ¯›çš®åŠå…¶è£½å“è£½é€ æ¥­",
            "é£Ÿå“åŠé£¼å“è£½é€ æ¥­", "é£²æ–™è£½é€ æ¥­", "è¸è‰è£½é€ æ¥­", "ç´™æ¼¿ã€ç´™åŠç´™è£½å“è£½é€ æ¥­",
            "å°åˆ·åŠè³‡æ–™å„²å­˜åª’é«”è¤‡è£½æ¥­", "æœ¨ç«¹è£½å“è£½é€ æ¥­", "å®¶å…·è£½é€ æ¥­",
            "æ±½è»ŠåŠå…¶é›¶ä»¶è£½é€ æ¥­", "å…¶ä»–é‹è¼¸å·¥å…·åŠå…¶é›¶ä»¶è£½é€ æ¥­", "ç”¢æ¥­ç”¨æ©Ÿæ¢°è¨­å‚™ç¶­ä¿®åŠå®‰è£æ¥­",
            "å…¶ä»–è£½é€ æ¥­", "è£½é€ æ¥­", "æ‰¹ç™¼åŠé›¶å”®æ¥­", "é‹è¼¸åŠå€‰å„²æ¥­", "ä½å®¿åŠé¤é£²æ¥­",
            "å‡ºç‰ˆå½±éŸ³åŠè³‡é€šè¨Šæ¥­", "é‡‘èåŠä¿éšªæ¥­", "ä¸å‹•ç”¢æ¥­", "å°ˆæ¥­ã€ç§‘å­¸åŠæŠ€è¡“æœå‹™æ¥­",
            "æ”¯æ´æœå‹™æ¥­", "å…¬å…±è¡Œæ”¿åŠåœ‹é˜²ï¼›å¼·åˆ¶æ€§ç¤¾æœƒå®‰å…¨", "æ•™è‚²æ¥­",
            "é†«ç™‚ä¿å¥åŠç¤¾æœƒå·¥ä½œæœå‹™æ¥­", "è—è¡“ã€å¨›æ¨‚åŠä¼‘é–’æœå‹™æ¥­", "å…¶ä»–æœå‹™æ¥­",
            "ç‡Ÿå»ºå·¥ç¨‹æ¥­", "ç”¨æ°´ä¾›æ‡‰åŠæ±¡æŸ“æ•´æ²»æ¥­", "é›»åŠ›åŠç‡ƒæ°£ä¾›æ‡‰æ¥­",
            "ç¤¦æ¥­åŠåœŸçŸ³æ¡å–æ¥­", "è¾²ã€æ—ã€æ¼ã€ç‰§æ¥­"
        ];

        const COLORS = ['#064E3B', '#10B981', '#34FF5B', '#60A5FA', '#8B5CF6', '#F59E0B', '#EC4899'];

        const row1Metrics = [
            { label: "ç¢³æ¸›é‡ (Carbon Red.)", key: "c_ç¢³æ¸›é‡ä¸­ä½æ•¸", unit: "t/yr", icon: "ğŸŒ±" },
            { label: "ç¯€èƒ½æ½›åŠ› (Energy Sav.)", key: "c_ç¯€èƒ½æ½›åŠ›ä¸­ä½æ•¸", unit: "kWh", icon: "âš¡", multiplier: 1000 },
            { label: "å›æ”¶å¹´é™ (Payback)", key: "c_å›æ”¶å¹´é™ä¸­ä½æ•¸", unit: "å¹´", icon: "â³" }
        ];

        const row2Metrics = [
            { label: "æŠ•è³‡æˆæœ¬ (Cost)", key: "c_æŠ•è³‡æˆæœ¬ä¸­ä½æ•¸", unit: "è¬å…ƒ", icon: "ğŸ’°" },
            { label: "å¹´ç¯€çœ (Savings)", key: "c_å¹´ç¯€çœæˆæœ¬ä¸­ä½æ•¸", unit: "è¬å…ƒ/å¹´", icon: "ğŸ“‰" },
            { label: "å–®ä½æˆæœ¬ (Unit Cost)", key: "c_å–®ä½æ¸›ç¢³æˆæœ¬ä¸­ä½æ•¸", unit: "å…ƒ/å™¸", icon: "ğŸ·ï¸" }
        ];

        // --- API Services ---
        const dataService = {
            async fetchRecommendations(industry, absoluteGoal, path) {
                try {
                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'getRecommendations',
                            industry,
                            absoluteGoal,
                            goalPath: path
                        })
                    });
                    const json = await response.json();
                    return json.success ? { items: [], aiAnalysis: "", ...json.data } : { type: 'none', items: [], aiAnalysis: json.error || "Backend Error" };
                } catch (e) {
                    return { type: 'none', items: [], aiAnalysis: e.message || "Network Error" };
                }
            },
            async fetchDashboardStats(params) {
                try {
                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'getDashboardStats', ...params })
                    });
                    const json = await response.json();
                    return json.success ? (json.data || {}) : {};
                } catch (e) {
                    return {};
                }
            },
            async saveUserProfile(userData) {
                try {
                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'saveUserProfile', userData })
                    });
                    return await response.json();
                } catch (e) {
                    throw e;
                }
            },
            async fetchGeminiAnalysis(industry, goal, items, type) {
                try {
                    const response = await fetch(GAS_API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ action: "getGeminiAnalysis", industry, goal, items, type }),
                    });
                    const json = await response.json();
                    return json.success ? (json.data || "") : "AI åˆ†ææš«æ™‚ç„¡æ³•å–å¾— (Backend Error)";
                } catch (e) {
                    return "AI åˆ†æé€£ç·šå¤±æ•—";
                }
            },
            processSystemDistribution(rawDocs) {
                const systemMap = {};
                rawDocs.forEach(doc => {
                    const sysName = doc.system;
                    if (sysName && !systemMap[sysName]) {
                        const ratio = doc.stats?.['a_ç³»çµ±ä½”æ¯”(åŒç”¢æ¥­)'] || 0;
                        systemMap[sysName] = ratio;
                    }
                });
                return Object.keys(systemMap).map(sys => ({
                    name: sys,
                    value: Math.round(systemMap[sys] * 1000) / 10
                }));
            }
        };

        // --- Helper Components ---
        const MainContainer = ({ children, className = "" }) => (
            <div
                className="min-h-screen flex items-center justify-center py-10 px-4 font-sans relative overflow-hidden"
            >
                <div className="app-bg"></div>
                <div className={`relative z-10 w-full max-w-6xl bg-white/95 rounded-[40px] shadow-2xl overflow-hidden border border-white ${className}`}>
                    {children}
                </div>
            </div>
        );

        const BackButton = ({ onClick }) => (
            <button
                onClick={onClick}
                className="flex items-center gap-2 text-slate-400 hover:text-[#064E3B] font-bold text-xs uppercase tracking-widest transition-all mb-8 group"
            >
                <span className="w-8 h-8 rounded-full border border-slate-100 flex items-center justify-center group-hover:border-[#064E3B] transition-all">â†</span>
                è¿”å›ä¿®æ”¹
            </button>
        );

        const formatValue = (value) => {
            const num = Number(value);
            if (isNaN(num) || num === 0) return "0";
            if (Math.abs(num) >= 1000000) {
                return new Intl.NumberFormat("en-US", {
                    notation: "compact",
                    compactDisplay: "short",
                    maximumFractionDigits: 1
                }).format(num);
            }
            return num.toLocaleString("en-US", {
                minimumFractionDigits: 0,
                maximumFractionDigits: 1
            });
        };

        const RecommendationCard = ({ item, index, onOpen, isEnergy, targetValue }) => {
            const format = (v) => {
                const n = typeof v === 'string' ? parseFloat(v.replace(/,/g, '')) : v;
                return isNaN(n) ? "0" : n.toLocaleString('en-US', { maximumFractionDigits: 1 });
            };

            return (
                <div className="bg-white p-6 rounded-[32px] border border-slate-100 hover:border-[#34FF5B] hover:shadow-xl transition-all group flex flex-col md:flex-row justify-between items-center animate-in" style={{ animationDelay: `${index * 100}ms` }}>
                    <div className="flex items-center gap-6 w-full md:w-auto mb-4 md:mb-0">
                        <div className={`w-12 h-12 rounded-2xl font-black text-xl flex items-center justify-center transition-all ${index === 0 ? 'bg-[#34FF5B] text-[#064E3B]' : 'bg-slate-50 text-slate-300 group-hover:bg-[#34FF5B] group-hover:text-[#064E3B]'}`}>
                            {index + 1}
                        </div>
                        <div>
                            <h4 className="font-black text-[#064E3B] text-xl mb-1">{item["ç³»çµ±åç¨±"]}</h4>
                            <div className="flex items-center gap-2">
                                <p className="text-slate-400 font-bold text-sm tracking-tight">{item["æªæ–½é¡å‹"] || item["æªæ–½åç¨±"]}</p>
                                {parseFloat(item["å›æ”¶å¹´é™(å¹´)"] || "99") < 3 && (
                                    <span className="bg-orange-50 text-orange-600 px-2 py-0.5 rounded-md text-[8px] font-black uppercase">ROI &lt; 3Y</span>
                                )}
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center gap-8 w-full md:w-auto justify-between md:justify-end">
                        <div className="text-right">
                            <p className="text-2xl font-black text-[#111827]">
                                {isEnergy ? format(parseFloat(item["ç¯€èƒ½æ½›åŠ›"] || "0") * 1000) : format(item["ç¢³æ¸›é‡(å…¬å™¸/å¹´)"])}
                                <span className="text-[10px] text-slate-400 ml-1">{isEnergy ? 'kWh' : 'tCO2e'}</span>
                            </p>
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                {(() => {
                                    const val = isEnergy ? parseFloat(item["ç¯€èƒ½æ½›åŠ›"] || "0") * 1000 : parseFloat(item["ç¢³æ¸›é‡(å…¬å™¸/å¹´)"] || "0");
                                    const gap = Math.max(0, targetValue - val);
                                    return gap <= 0 ? (
                                        <span className="text-emerald-500">âœ¨ å·²é”æˆ/è¶…è¶Šç›®æ¨™ !</span>
                                    ) : (
                                        <span>è·é›¢ç›®æ¨™é‚„å·® {formatValue(gap)} {isEnergy ? 'kWh' : 't'}</span>
                                    );
                                })()}
                            </p>
                        </div>
                        <button
                            onClick={onOpen}
                            className="bg-[#34FF5B] text-[#064E3B] px-6 py-3 rounded-2xl font-black text-sm hover:scale-105 transition-all shadow-lg active:scale-95"
                        >
                            è©³æƒ…
                        </button>
                    </div>
                </div>
            );
        };

        const DetailModal = ({ item, onClose, onRFQ, industry }) => {
            const format = (v, decimals = 1) => {
                const n = typeof v === 'string' ? parseFloat(v.replace(/,/g, '')) : v;
                return isNaN(n) ? "0" : n.toLocaleString('en-US', { maximumFractionDigits: decimals });
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 overflow-hidden" onClick={onClose}>
                    <div className="bg-white rounded-[48px] max-w-4xl w-full p-8 md:p-12 animate-in relative overflow-y-auto max-h-[95vh]" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-8 right-8 w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:text-slate-800 text-2xl font-light transition-all">âœ•</button>

                        <div className="mb-10">
                            <span className="bg-emerald-50 text-[#064E3B] px-4 py-1.5 rounded-xl text-[10px] font-black tracking-widest uppercase mb-4 inline-block">{industry}</span>
                            <h2 className="text-4xl md:text-5xl font-black text-[#064E3B] leading-tight mb-2">{item["ç³»çµ±åç¨±"]}</h2>
                            <p className="text-xl font-bold text-slate-400">{item["æªæ–½åç¨±"] || item["æªæ–½é¡å‹"]}</p>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-10">
                            {[
                                { label: 'æ¸›ç¢³æ•ˆç›Š', val: format(item["ç¢³æ¸›é‡(å…¬å™¸/å¹´)"], 2), unit: 'tCO2e' },
                                { label: 'ç¯€èƒ½æ½›åŠ›', val: format(parseFloat(item["ç¯€èƒ½æ½›åŠ›"] || "0") * 1000, 0), unit: 'kWh' },
                                { label: 'å›æ”¶å¹´é™', val: format(item["å›æ”¶å¹´é™(å¹´)"], 1), unit: 'å¹´' },
                                { label: 'æŠ•è³‡æˆæœ¬', val: format(item["ä¼æ¥­æŠ•è³‡æˆæœ¬(è¬å…ƒ)"], 2), unit: 'è¬' },
                                { label: 'å¹´ç¯€çœ', val: format(item["å¹´ç¯€çœæˆæœ¬(è¬å…ƒ)"], 2), unit: 'è¬' },
                                { label: 'å–®ä½æˆæœ¬', val: format(item["å–®ä½æ¸›ç¢³æˆæœ¬(å…ƒ/å™¸)"], 0), unit: 'å…ƒ/å™¸' },
                            ].map((stat, i) => (
                                <div key={i} className="bg-slate-50/50 p-6 rounded-3xl border border-slate-100">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">{stat.label}</p>
                                    <p className="text-3xl font-black text-[#111827]">{stat.val} <span className="text-xs text-slate-400 ml-1 font-bold">{stat.unit}</span></p>
                                </div>
                            ))}
                        </div>

                        <div className="space-y-6 mb-12">
                            <div className="bg-slate-50/30 p-8 rounded-[32px] border border-slate-100">
                                <h4 className="text-sm font-black text-emerald-800 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    ä¼æ¥­ç—›é» (Pain Points)
                                </h4>
                                <p className="text-slate-600 font-medium leading-relaxed">{item["ä¼æ¥­å•é¡Œé—¡è¿°"] || 'ç›®å‰é‡å°æ­¤ç³»çµ±ä¹‹ç‰¹å®šç—›é»è³‡æ–™å½™æ•´ä¸­ã€‚'}</p>
                            </div>
                            <div className="bg-blue-50/30 p-8 rounded-[32px] border border-blue-100">
                                <h4 className="text-sm font-black text-blue-800 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    è§£æ±ºæ–¹æ¡ˆ (Solution)
                                </h4>
                                <p className="text-slate-600 font-medium leading-relaxed">{item["è§£æ±ºæ–¹æ¡ˆé—¡è¿°"] || 'é‡å°æ­¤æ¡ˆä¹‹æœ€ä½³åŒ–è§£æ±ºæ–¹æ¡ˆå»ºè­°ç ”æ“¬ä¸­ã€‚'}</p>
                            </div>
                        </div>

                        <button
                            onClick={onRFQ}
                            className="w-full bg-[#34FF5B] text-[#064E3B] py-7 rounded-[32px] font-black text-2xl hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-4 shadow-2xl shadow-emerald-200"
                        >
                            å³åˆ»å°‹æ‰¾è§£æ±ºæ–¹æ¡ˆ <span className="text-3xl">â†’</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [isLoading, setIsLoading] = useState(false);
            const [step, setStep] = useState(1);
            const [industry, setIndustry] = useState('');
            const [phone, setPhone] = useState('');
            const [taxId, setTaxId] = useState('');
            const [industrySearch, setIndustrySearch] = useState('');
            const [showSuggestions, setShowSuggestions] = useState(false);
            const suggestionRef = useRef(null);

            const [targetVal, setTargetVal] = useState('');
            const [userGoal, setUserGoal] = useState(null);
            const [recommendations, setRecommendations] = useState(null);
            const [selectedAction, setSelectedAction] = useState(null);
            const [currentVal, setCurrentVal] = useState("");
            const [goalMode, setGoalMode] = useState("unset");
            const [goalPath, setGoalPath] = useState("carbon");
            const [targetType, setTargetType] = useState("percentage");
            const [dashboardStats, setDashboardStats] = useState(null);
            const [systemDistribution, setSystemDistribution] = useState([]);
            const [selectedSystem, setSelectedSystem] = useState(null);
            const [selectedMeasure, setSelectedMeasure] = useState(null);
            const analysisRef = useRef(null);

            const isPhoneValid = phone.startsWith('09') && phone.length === 10;
            const isTaxIdValid = taxId.length === 8;

            const filteredSuggestions = useMemo(() => {
                const s = industrySearch.toLowerCase().trim();
                if (!s) return INDUSTRIES.slice(0, 5);
                return INDUSTRIES.filter(i => i.toLowerCase().includes(s)).slice(0, 10);
            }, [industrySearch]);

            useEffect(() => {
                const click = (e) => {
                    if (suggestionRef.current && !suggestionRef.current.contains(e.target)) setShowSuggestions(false);
                };
                document.addEventListener("mousedown", click);
                return () => document.removeEventListener("mousedown", click);
            }, []);

            const handleProfileSubmit = (e) => {
                e.preventDefault();
                if (industry && isPhoneValid && isTaxIdValid) {
                    setStep(2);
                    dataService.saveUserProfile({ industry, phone, taxId }).catch(console.error);
                }
            };

            const handleConfirmGoal = async () => {
                setIsLoading(true);
                const g = {
                    path: goalPath,
                    type: targetType,
                    value: parseFloat(targetVal.replace(/,/g, '')) || 0,
                    currentValue: parseFloat(currentVal.replace(/,/g, '')) || 0
                };
                setUserGoal(g);

                let absoluteGoal = g.value;
                if (g.type === 'percentage') {
                    absoluteGoal = g.currentValue * (g.value / 100);
                }

                try {
                    const [recs, stats] = await Promise.all([
                        dataService.fetchRecommendations(industry, absoluteGoal, goalPath),
                        dataService.fetchDashboardStats({ industry })
                    ]);
                    setRecommendations(recs);
                    setDashboardStats(stats);
                    if (stats.rawDocs) {
                        setSystemDistribution(dataService.processSystemDistribution(stats.rawDocs));
                    }
                    setGoalMode('has_goal');
                    setStep(3);
                    if (recs && recs.items && recs.items.length > 0) {
                        dataService.fetchGeminiAnalysis(
                            industry,
                            g.type === 'percentage' ? g.value + "%" : g.value,
                            recs.items,
                            recs.type
                        ).then(aiText => {
                            setRecommendations(prev => prev ? ({ ...prev, analysis: aiText }) : null);
                        });
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleNoGoal = async () => {
                setIsLoading(true);
                setGoalMode('no_goal');
                setStep(3);
                try {
                    const stats = await dataService.fetchDashboardStats({ industry });
                    setDashboardStats(stats);
                    if (stats.rawDocs) {
                        setSystemDistribution(dataService.processSystemDistribution(stats.rawDocs));
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    setIsLoading(false);
                }
            };

            const getMeasuresForSystem = (sysName) => {
                if (!dashboardStats?.rawDocs) return [];
                return dashboardStats.rawDocs
                    .filter(d => d.system === sysName)
                    .map(d => ({
                        name: d.action,
                        rate: d.stats?.['b_æªæ–½ä½”æ¯”(åŒç”¢æ¥­Ã—ç³»çµ±)'] || 0,
                        fullData: d
                    }))
                    .sort((a, b) => b.rate - a.rate);
            };

            const handleRFQ = (row) => {
                const u = new URLSearchParams({
                    industry,
                    system: row["ç³»çµ±åç¨±"] || selectedSystem || '',
                    action: row["æªæ–½åç¨±"] || row["æªæ–½é¡å‹"] || selectedMeasure?.action || '',
                    target: userGoal ? `${userGoal.value}${userGoal.type === 'percentage' ? '%' : (userGoal.path === 'carbon' ? 't' : 'kWh')}` : 'none'
                });
                window.location.href = `https://rfq.netellus.com/rfq/create?${u.toString()}`;
            };

            const renderMetricCard = (metric, idx) => {
                if (!selectedMeasure?.stats) return null;
                const rawVal = selectedMeasure.stats[metric.key];
                let val = (rawVal !== undefined && rawVal !== null) ? Number(rawVal) : 0;
                if (metric.multiplier) val *= metric.multiplier;

                return (
                    <div key={idx} className="bg-white/5 p-6 rounded-[32px] border border-white/10 hover:bg-white/10 transition-all group text-center flex flex-col justify-center min-h-[160px] gap-2">
                        <div className="text-3xl mb-4 group-hover:scale-110 transition-transform">{metric.icon}</div>
                        <div className="text-white/40 text-[9px] font-black mb-2 uppercase tracking-widest leading-tight h-6">{metric.label}</div>
                        <div className="text-lg font-black text-[#34FF5B] break-words">
                            {formatValue(val)}
                            <span className="text-[10px] text-white/30 ml-1 font-bold">{metric.unit}</span>
                        </div>
                    </div>
                );
            };

            if (isLoading && step !== 3) {
                return (
                    <MainContainer className="max-w-md text-center py-20">
                        <div className="w-16 h-16 border-4 border-[#064E3B] border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                        <p className="text-[#064E3B] font-bold tracking-widest uppercase animate-pulse">Analyzing...</p>
                    </MainContainer>
                );
            }

            if (step === 1) {
                return (
                    <MainContainer className="max-w-lg p-10 md:p-14">
                        <div className="text-center mb-12">
                            <h1 className="text-3xl font-black mb-2 text-[#111827]">ä¼æ¥­æ¸›ç¢³æ±ºç­–ç³»çµ±</h1>
                            <p className="text-slate-400 font-bold uppercase tracking-widest text-xs">Netellus Intelligence Hub</p>
                        </div>
                        <form onSubmit={handleProfileSubmit} className="space-y-8">
                            <div className="relative" ref={suggestionRef}>
                                <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3 block text-center">ç”¢æ¥­é¡åˆ¥</label>
                                <input
                                    required
                                    type="text"
                                    value={industrySearch}
                                    onChange={(e) => {
                                        const val = e.target.value;
                                        setIndustrySearch(val);
                                        setIndustry(val);
                                        setShowSuggestions(true);
                                    }}
                                    onFocus={() => setShowSuggestions(true)}
                                    className="w-full h-16 rounded-3xl bg-slate-50 border-2 border-slate-100 focus:border-[#34FF5B] transition-all px-8 text-xl font-bold"
                                    placeholder="æœå°‹ç”¢æ¥­..."
                                />
                                {showSuggestions && filteredSuggestions.length > 0 && (
                                    <div className="absolute z-50 top-full left-0 right-0 mt-2 bg-white rounded-3xl border border-slate-100 shadow-2xl overflow-hidden">
                                        {filteredSuggestions.map((ind, i) => (
                                            <div key={i} onMouseDown={() => { setIndustry(ind); setIndustrySearch(ind); setShowSuggestions(false); }} className="px-8 py-4 hover:bg-emerald-50 cursor-pointer font-bold text-slate-600 transition-colors">
                                                {ind}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <input required type="tel" value={phone} onChange={(e) => setPhone(e.target.value.replace(/\D/g, '').slice(0, 10))} className="w-full h-16 rounded-3xl bg-slate-50 border-2 border-slate-100 px-6 font-bold text-center" placeholder="æ‰‹æ©Ÿ 09xx" />
                                <input required type="text" value={taxId} onChange={(e) => setTaxId(e.target.value.replace(/\D/g, '').slice(0, 8))} className="w-full h-16 rounded-3xl bg-slate-50 border-2 border-slate-100 px-6 font-bold text-center" placeholder="çµ±ä¸€ç·¨è™Ÿ" />
                            </div>
                            <button type="submit" disabled={!industry || !isPhoneValid || !isTaxIdValid} className="w-full bg-[#064E3B] text-[#34FF5B] h-16 rounded-3xl font-black text-xl hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50">
                                é€²å…¥æ¢ç´¢æ¨¡å¼
                            </button>
                        </form>
                    </MainContainer>
                );
            }

            if (step === 2) {
                return (
                    <MainContainer className="max-w-2xl p-10 md:p-14">
                        <BackButton onClick={() => setStep(1)} />
                        <div className="text-center mb-10">
                            <h2 className="text-3xl font-black text-slate-800">æ‚¨æ˜¯å¦æœ‰å…·é«”çš„æ¸›ç¢³ç›®æ¨™ï¼Ÿ</h2>
                        </div>
                        <div className="grid md:grid-cols-2 gap-6">
                            <button onClick={() => setGoalMode('has_goal')} className={`p-8 rounded-[40px] border-2 transition-all text-left group ${goalMode === 'has_goal' ? 'border-[#34FF5B] bg-emerald-50' : 'border-slate-100 hover:border-slate-300'}`}>
                                <div className="w-12 h-12 rounded-2xl bg-[#064E3B] text-white flex items-center justify-center mb-6 font-black text-2xl group-hover:scale-110 transition-transform">âœ“</div>
                                <h3 className="font-black text-xl mb-2">æˆ‘å·²æœ‰æ˜ç¢ºç›®æ¨™</h3>
                                <p className="text-slate-400 text-sm font-medium">æˆ‘å€‘å°‡ä¾ç…§ç›®æ¨™ç¼ºå£ç‚ºæ‚¨æ¨è–¦æœ€ä½³æŠ€è¡“çµ„åˆã€‚</p>
                            </button>
                            <button onClick={handleNoGoal} className="p-8 rounded-[40px] border-2 border-slate-100 hover:border-slate-300 transition-all text-left group">
                                <div className="w-12 h-12 rounded-2xl bg-white border border-slate-200 text-slate-400 flex items-center justify-center mb-6 font-black text-xl group-hover:rotate-12 transition-transform">ï¼Ÿ</div>
                                <h3 className="font-black text-xl mb-2">æš«ç„¡ç›®æ¨™ï¼Œå…ˆé€›é€›</h3>
                                <p className="text-slate-400 text-sm font-medium">ç›´æ¥æŸ¥çœ‹è©²ç”¢æ¥­çš„ç†±é–€æ”¹é€²ç³»çµ±èˆ‡æˆåŠŸæ¡ˆä¾‹ã€‚</p>
                            </button>
                        </div>

                        {goalMode === 'has_goal' && (
                            <div className="mt-10 p-8 bg-slate-50 rounded-[40px] animate-in" style={{ animationDelay: '0ms' }}>
                                <div className="grid md:grid-cols-2 gap-8">
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3 block">æ¸›é‡æ¨™çš„</label>
                                        <div className="flex bg-white p-2 rounded-2xl border border-slate-200">
                                            <button onClick={() => setGoalPath('carbon')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${goalPath === 'carbon' ? 'bg-[#064E3B] text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`}>ç¢³æ’ (t)</button>
                                            <button onClick={() => setGoalPath('energy')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${goalPath === 'energy' ? 'bg-[#064E3B] text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`}>èƒ½æº (kWh)</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3 block">ç›®æ¨™é¡å‹</label>
                                        <div className="flex bg-white p-2 rounded-2xl border border-slate-200">
                                            <button onClick={() => setTargetType('percentage')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${targetType === 'percentage' ? 'bg-[#064E3B] text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`}>ç™¾åˆ†æ¯”</button>
                                            <button onClick={() => setTargetType('absolute')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${targetType === 'absolute' ? 'bg-[#064E3B] text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'}`}>çµ•å°å€¼</button>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-8 grid md:grid-cols-2 gap-8">
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3 block">{goalPath === 'carbon' ? 'ç›®å‰å¹´æ’ç¢³é‡ (t)' : 'ç›®å‰å¹´è€—é›»é‡ (kWh)'}</label>
                                        <input type="text" value={currentVal} onChange={(e) => setCurrentVal(e.target.value.replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","))} className="w-full h-16 rounded-3xl bg-white border border-slate-200 px-6 font-black text-2xl focus:border-[#34FF5B]" placeholder="0" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3 block">{targetType === 'percentage' ? 'é è¨ˆæ¸›é‡ %' : 'é è¨ˆæ¸›é‡æ¨™çš„'}</label>
                                        <input type="text" value={targetVal} onChange={(e) => setTargetVal(e.target.value.replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","))} className="w-full h-16 rounded-3xl bg-white border border-slate-200 px-6 font-black text-2xl focus:border-[#34FF5B]" placeholder="0" />
                                    </div>
                                </div>
                                <button onClick={handleConfirmGoal} className="w-full mt-10 bg-[#064E3B] text-[#34FF5B] h-16 rounded-3xl font-black text-xl hover:scale-[1.02] transition-all">
                                    å±•é–‹ç­–ç•¥åœ°åœ–
                                </button>
                            </div>
                        )}
                    </MainContainer>
                );
            }

            return (
                <MainContainer className="max-w-6xl">
                    <div className="p-8 md:p-12">
                        <div className="flex justify-between items-start mb-10">
                            <BackButton onClick={() => {
                                if (selectedMeasure) setSelectedMeasure(null);
                                else if (selectedSystem) setSelectedSystem(null);
                                else setStep(2);
                            }} />
                            <div className="text-right">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Industry View</p>
                                <p className="font-black text-xl text-slate-800">{industry}</p>
                            </div>
                        </div>

                        {recommendations && (
                            <div className="grid lg:grid-cols-1 gap-12">
                                <div className="lg:col-span-1">
                                    {userGoal && (
                                        <div className="mb-8">
                                            <span className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-4 inline-block ${recommendations?.type === 'portfolio' ? 'bg-blue-600 text-white' : 'bg-[#064E3B] text-white'}`}>
                                                {recommendations?.type === 'portfolio' ? 'çµ„åˆç­–ç•¥å»ºè­° (Portfolio)' : 'ç²¾é¸åŒ¹é…æ¡ˆä¾‹ (Single Match)'}
                                            </span>
                                            <h1 className="text-3xl md:text-5xl font-black text-[#111827] mb-6 leading-tight">
                                                {recommendations?.type === 'portfolio' ? 'ç›®æ¨™ç¼ºå£é¡¯è‘—ï¼Œå»ºè­°æ¡å–è¤‡åˆæªæ–½' : 'æ‰¾åˆ°æœ€ç¬¦åˆæ‚¨ç›®æ¨™çš„ç¯€èƒ½æ”¹é€²æ–¹æ¡ˆ'}
                                            </h1>
                                            <div className="p-8 bg-slate-900 rounded-[32px] text-white flex flex-col md:flex-row items-center justify-between shadow-2xl gap-8">
                                                <div>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 text-[#34FF5B]">æ‚¨çš„æ¸›é‡ç›®æ¨™ (YOUR TARGET)</p>
                                                    <p className="text-3xl md:text-5xl font-black text-white">
                                                        {formatValue(userGoal.type === 'percentage' ? userGoal.currentValue * (userGoal.value / 100) : userGoal.value)}
                                                        <span className="text-lg text-slate-400 ml-2">{userGoal.path === 'carbon' ? 't' : 'kWh'}</span>
                                                    </p>
                                                </div>
                                                <div className="text-right border-l-0 md:border-l border-white/10 pl-0 md:pl-8 w-full md:w-auto">
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">AI é ä¼°é”æˆç‡</p>
                                                    <p className="text-3xl md:text-5xl font-black">{recommendations?.type === 'portfolio' ? '95%+' : '100%+'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {!userGoal && (
                                        <div className="mb-8">
                                            <span className="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-4 inline-block bg-slate-100 text-slate-600">ç”¢æ¥­æ¢ç´¢æ¨¡å¼</span>
                                            <h1 className="text-3xl md:text-5xl font-black text-[#111827] mb-6 leading-tight">
                                                ç‚ºæ‚¨åˆ†æã€Œ{selectedSystem || 'å…¨ç³»çµ±'}ã€çš„æ”¹é€²è¶¨å‹¢
                                            </h1>
                                        </div>
                                    )}

                                    <div className="mt-8 p-8 bg-emerald-50 rounded-[32px] border border-emerald-100/50 relative">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="w-8 h-8 rounded-full bg-[#064E3B] text-white flex items-center justify-center font-black text-xs">AI</div>
                                            <h3 className="font-black text-[#064E3B] text-sm uppercase tracking-widest">é¡§å•åˆ†æå ±å‘Š</h3>
                                        </div>
                                        <p className="text-gray-700 italic font-medium">
                                            {recommendations?.analysis || "æ­£åœ¨é€²è¡Œæ·±åº¦åˆ†æä¸­..."}
                                        </p>
                                    </div>

                                    <div className="mt-12">
                                        <h3 className="text-xl md:text-2xl font-black mb-8 text-[#111827] flex items-center gap-3">
                                            <span className="w-2 h-8 bg-[#34FF5B] rounded-full"></span>
                                            {userGoal ? 'åŒæ¥­åŸ·è¡Œæˆæ•ˆåƒè€ƒ (Median Analysis)' : 'ç”¢æ¥­ç†±é–€è½‰å‹æ¡ˆä¾‹'}
                                        </h3>
                                        <div className="space-y-6">
                                            {recommendations?.items?.length ? (
                                                recommendations.items.map((row, idx) => (
                                                    <RecommendationCard
                                                        key={idx}
                                                        item={row}
                                                        index={idx}
                                                        onOpen={() => setSelectedAction(row)}
                                                        isEnergy={userGoal?.path === 'energy'}
                                                        targetValue={userGoal?.type === 'percentage' ? userGoal.currentValue * (userGoal.value / 100) : userGoal.value || 0}
                                                    />
                                                ))
                                            ) : (
                                                <div className="text-center py-20 bg-slate-50 rounded-[40px] border-2 border-dashed border-slate-200 px-8">
                                                    <p className="text-slate-400 font-black text-lg">æš«ç„¡å®Œå…¨åŒ¹é…çš„æ¡ˆä¾‹ï¼Œè«‹å˜—è©¦èª¿æ•´ç›®æ¨™æ•¸å€¼ã€‚</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="mt-20 pt-20 border-t border-slate-100" ref={analysisRef}>
                            <div className="mb-12 text-center">
                                <span className="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-4 inline-block bg-slate-100 text-slate-600">Deep Dive Analysis</span>
                                <h2 className="text-3xl md:text-4xl font-black text-[#111827]">åŒæ¥­ç¯€èƒ½èˆ‡æ¸›ç¢³ç«¶çˆ­åŠ›åˆ†æ</h2>
                                <p className="text-slate-400 font-bold mt-2">é»æ“Šåœ“é¤…åœ–æˆ–æŒ‡æ¨™å¡ç‰‡é€²è¡Œæ·±å±¤æ¢ç´¢</p>
                            </div>

                            <div className="grid lg:grid-cols-2 gap-12 items-center mb-20 bg-slate-50 p-6 md:p-10 rounded-[48px]">
                                <div className="h-80 relative">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie
                                                data={systemDistribution}
                                                innerRadius={80} outerRadius={110} paddingAngle={8} dataKey="value" stroke="none"
                                                onClick={(data) => {
                                                    setSelectedSystem(data.name);
                                                    setSelectedMeasure(null);
                                                }}
                                            >
                                                {systemDistribution.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} className="hover:opacity-80 transition-opacity cursor-pointer" />)}
                                            </Pie>
                                            <Tooltip />
                                        </PieChart>
                                    </ResponsiveContainer>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-tight">Main Systems</p>
                                        <p className="text-xl font-black text-[#064E3B]">{systemDistribution.length}</p>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    {[...systemDistribution].sort((a, b) => b.value - a.value).map((item, i) => (
                                        <button
                                            key={i}
                                            onClick={() => { setSelectedSystem(item.name); setSelectedMeasure(null); }}
                                            className={`w-full flex justify-between items-center p-5 rounded-3xl transition-all shadow-sm ${selectedSystem === item.name ? 'bg-[#064E3B] text-white scale-[1.02] shadow-xl' : 'bg-white text-slate-600 hover:bg-slate-100'}`}
                                        >
                                            <span className="flex items-center gap-3 font-black text-sm text-left">
                                                <div className="w-3 h-3 rounded-full shrink-0" style={{ background: COLORS[i % COLORS.length] }}></div>
                                                {item.name}
                                            </span>
                                            <span className={`font-black text-sm shrink-0 ml-4 ${selectedSystem === item.name ? 'text-[#34FF5B]' : 'text-[#064E3B]'}`}>{formatValue(item.value)}%</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {selectedSystem && (
                                <div className="animate-in mb-20">
                                    <h3 className="text-xl font-black text-[#064E3B] mb-8 flex items-center gap-3">
                                        <span className="w-1.5 h-6 bg-[#064E3B] rounded-full"></span>
                                        {selectedSystem} - å¸¸ç”¨æ”¹é€²æªæ–½ä½”æ¯”
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {getMeasuresForSystem(selectedSystem).map((m, idx) => (
                                            <div
                                                key={idx}
                                                onClick={() => setSelectedMeasure(m.fullData)}
                                                className={`cursor-pointer p-6 rounded-[32px] border-2 transition-all group ${selectedMeasure?.action === m.name
                                                    ? 'border-[#34FF5B] bg-emerald-50 shadow-lg'
                                                    : 'border-slate-100 hover:border-[#34FF5B] bg-white'
                                                    }`}
                                            >
                                                <div className="flex justify-between items-start mb-4 gap-2">
                                                    <span className="font-black text-lg text-[#064E3B] group-hover:text-[#10B981] transition-colors">{m.name}</span>
                                                    <span className="text-[10px] font-black bg-[#064E3B] text-[#34FF5B] px-3 py-1 rounded-full uppercase tracking-widest shrink-0">
                                                        {formatValue(m.rate * 100)}%
                                                    </span>
                                                </div>
                                                <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden mb-2">
                                                    <div className="bg-[#34FF5B] h-full transition-all duration-1000" style={{ width: `${m.rate * 100}%` }}></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {selectedMeasure && selectedMeasure.stats && (
                                <div className="animate-in bg-[#064E3B] p-8 md:p-14 rounded-[56px] text-white shadow-2xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-[#34FF5B]/10 rounded-full blur-[100px] -mr-32 -mt-32"></div>
                                    <h3 className="text-2xl font-black text-white mb-10 flex items-center gap-4 relative z-10">
                                        <span className="text-[#34FF5B] text-3xl">ğŸ“Š</span>
                                        {selectedSystem} â€º {selectedMeasure.action} : åŒæ¥­ä¸­ä½æ•¸æ¨™ç«¿
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 relative z-10">
                                        {row1Metrics.map((metric, idx) => renderMetricCard(metric, idx))}
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
                                        {row2Metrics.map((metric, idx) => renderMetricCard(metric, idx + 3))}
                                    </div>
                                    <button
                                        onClick={() => handleRFQ({ system: selectedSystem, action: selectedMeasure.action })}
                                        className="w-full mt-12 bg-[#34FF5B] text-[#064E3B] py-6 rounded-3xl font-black text-lg hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3 shadow-xl"
                                    >
                                        ç²å–å®Œæ•´è½‰å‹è©•ä¼°å ±å‘Š <span>â†’</span>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {selectedAction && (
                        <DetailModal
                            item={selectedAction}
                            industry={industry}
                            onClose={() => setSelectedAction(null)}
                            onRFQ={() => handleRFQ(selectedAction)}
                        />
                    )}
                </MainContainer>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>

</html>
